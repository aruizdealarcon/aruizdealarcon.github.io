<!DOCTYPE html>
<html style="margin 0 auto">
  <head>
    <meta name="robots" content="noindex, nofollow" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /> 
    <script>
      function reorderTikzNodes(tikzCode) {
          // Patrón para encontrar bloques de tikzpicture
          const tikzPattern = /\\begin{tikzpicture}([\s\S]*?)\\end{tikzpicture}/g;
      
          // Función para procesar cada bloque de tikzpicture encontrado
          return tikzCode.replace(tikzPattern, (match) => {
              // Separamos los nodos del resto del contenido
              const nodePattern = /(\\node.*?;)/g;
              let nodes = [];
              let content = match.replace(nodePattern, (nodeMatch) => {
                  nodes.push(nodeMatch);
                  return "";  // Removemos el nodo del lugar original
              });
      
              // Agregamos los nodos encontrados antes del \end{tikzpicture}
              content = content.replace(/\\end{tikzpicture}/, nodes.join("\n") + "\n\\end{tikzpicture}");
      
              // Eliminamos líneas vacías adicionales
              content = content.replace(/^\s*[\r\n]/gm, '');
      
              return content;
          });
      }
      function scaleCoordinates(tikzCode) {
          // Patrón para encontrar todas las coordenadas (x,y)
          const coordPattern = /\((-?\d+\.?\d*),\s*(-?\d+\.?\d*)\)/g;
      
          // Función para procesar y reemplazar cada coincidencia
          const replacementFunction = (match, p1, p2) => {
              // Convertimos los valores a números y los dividimos por 100
              let x = parseFloat(p1) / 100;
              let y = parseFloat(p2) / 100;
              // Formateamos el resultado a un número con precisión adecuada
              // (opcional) y devolvemos la nueva coordenada
              return `(${x.toFixed(3)},${y.toFixed(3)})`;
          };
      
          // Reemplazamos en el código original
          return tikzCode.replace(coordPattern, replacementFunction);
      }
      function scaleRadius(tikzCode) {
          // Patrón para encontrar todas las cadenas 'radius=x'
          const radiusPattern = /radius\s*=\s*(-?\d+\.?\d*)/g;
      
          // Función para procesar y reemplazar cada coincidencia
          const replacementFunction = (match, p1) => {
              // Convertimos el valor a número y lo dividimos por 100
              let scaledValue = parseFloat(p1) / 100;
              // Formateamos el resultado a un número con precisión de tres decimales
              return `radius=${scaledValue.toFixed(3)}`;
          };
      
          // Reemplazamos en el código original
          return tikzCode.replace(radiusPattern, replacementFunction);
      }
      function removeNoDisplayDraws(tikzCode) {
          // Patrón para encontrar \draw con 'nodisplay' en sus atributos
          const drawPattern = /\\draw\s*\[[^\]]*nodisplay[^\]]*\][\s\S]*?;/g;
      
          // Reemplazamos los \draw que cumplen con el patrón por una cadena vacía
          return tikzCode.replaceAll(drawPattern, '');
      }
      function tikzReplace(){
        let ntext = document.getElementById("myInp").value;
        ntext = ntext.replaceAll(/\\pic\[fill=white/g, "\\node[white tensor");
        ntext = ntext.replaceAll(/\\pic\[orange/g, "\\node[orange tensor");
        ntext = ntext.replaceAll(/\\pic\[darkorange/g, "\\node[orange tensor");
        ntext = ntext.replaceAll(/\\pic\[red/g, "\\node[red tensor");
        ntext = ntext.replaceAll(/\\pic\[blue/g, "\\node[blue tensor");
        ntext = ntext.replaceAll(/\\pic\[gray/g, "\\node[gray tensor");
        ntext = ntext.replaceAll(/turquoise/g, "nodisplay");
        ntext = ntext.replaceAll(/->/g, "arr");
        ntext = ntext.replaceAll(/<-/g, "arr rev");
        ntext = ntext.replaceAll(/darkorange/g, "virtual");
        ntext = ntext.replaceAll(/\\pic/g, "\\node[black tensor]");
        ntext = ntext.replaceAll(/\{ipe [A-Za-z0-9]+\}/g, "{}");
        ntext = ntext.replaceAll(/\[ipe import, baseline, trim left\]/g, "");
        ntext = ntext.replaceAll(/, ,/g, ",");
        ntext = ntext.replaceAll(/\]\n\s+at\s\(/g, "] at (");
        ntext = ntext.replaceAll(/\)\n\s+--\s/g, ") -- ");
        ntext = ntext.replaceAll(/\)\n\s+arc/g, ") arc");
        //ntext = ntext.replaceAll(/\b\d+\.\d{4}\b/g, (match) => { return parseFloat(match).toFixed(2); });
        ntext = scaleCoordinates(ntext);
        ntext = scaleRadius(ntext);
        ntext = removeNoDisplayDraws(ntext);
        ntext = reorderTikzNodes(ntext);
        document.getElementById("myOutp").value = ntext;
      }
    </script>
    <script>
      function tikzRepCopy(){
         tikzReplace();
        var copyText = document.getElementById("myOutp");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
      }
    </script>
  </head>
  <!-- 
        ntext = ntext.replace('\\pic[orange]', '\\node[red tensor]');
        ntext = ntext.replace('{ipe disk}', '{}');
        ntext = ntext.replace('{ipe fdisk}', '{}');
        ntext = ntext.replace('[ipe import, baseline, trim left]', '[scale=0.01]');
        ntext = ntext.replace('darkorange', 'virtual');
        ntext = ntext.replace('\\pic', '\\node');
  -->
  <body style="margin 0 auto; text-align:center">
    <h1>IPE TikZ Code Formatter</h1>
      Settings file: <a href="/tikz/tikz_custom.tex">tikz_custom.tex</a>
    <div>
    <textarea rows="40" cols="70" id="myInp"></textarea>
    <textarea rows="40" cols="70" id="myOutp" style="background-color:#f3fff6"></textarea>
    </div>
    <button style="padding: 20px" id="buttonC" onclick="tikzReplace();">Convert</button>
    <button style="padding: 20px" id="buttonCC" onclick="tikzRepCopy();">Convert &amp; copy to clipboard</button>
  </body>
</html>
